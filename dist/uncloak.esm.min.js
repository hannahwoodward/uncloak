class UncloakItem{constructor(t,e,i){t.removeAttribute("data-uncloak-new"),this.callbacks=i.callbacks||{init:[],uncloak:[]},this.cloaked=!0,this.uncloakReady=!1,this.delayTimer={y0:0,y1:null},this.delayType=t.getAttribute("data-uncloak-delay-type")||null,this.delayTypes=i.delayTypes||{},this.instance=e,this.lazyContent=t.hasAttribute("data-uncloak-ignore-lazy")?[]:t.querySelectorAll("[data-uncloak-src], [data-uncloak-srcset]"),this.lazyContentLoadStatus=this.lazyContent[0]?-1:2,this.node=t,this.threshold=parseFloat(t.getAttribute("data-uncloak-threshold"))||0,this.lazyContentObserver=null}init(){this.lazyContent[0]&&(this.lazyContentObserver=new IntersectionObserver(t=>{t[0].isIntersecting&&(this.loadLazyContent(),this.lazyContentObserver.disconnect())},{rootMargin:"50%"}),this.lazyContentObserver.observe(this.node)),this.runCallbacks("init")}process(t){return this.cloaked&&(null!==this.delayType&&null===this.delayTimer.y1&&(this.delayTimer={y0:performance.now(),y1:this.createDelayTimeout(t,this.delayType)},t++),this.imagesLoaded()?this.uncloak():this.uncloakReady=!0),t}uncloak(){if(!this.cloaked)return;this.cloaked=!1;const t=performance.now()-this.delayTimer.y0,e=this.delayTimer.y1-t,doUncloak=()=>{this.node.classList.remove("uncloak--cloaked"),this.runCallbacks("uncloak")};e<=0?doUncloak():setTimeout(doUncloak,e)}reset(t=!0){this.cloaked=!0,this.delayTimer={y0:0,y1:null},this.node.classList.add("uncloak--cloaked"),t&&this.instance.nodeObserver.observe(this.node)}runCallbacks(t){const e=this.callbacks[t];if(e&&e.length)for(let i=0;i<e.length;i++)e[i](this)}createDelayTimeout(t,e){return this.delayTypes&&this.delayTypes[e](t)||0}loadLazyContent(){if(this.imagesLoaded()||1===this.lazyContentLoadStatus)return;this.lazyContentLoadStatus=1;let t=this.lazyContent.length;const loaded=e=>()=>{e.removeEventListener("load",loaded,!1),e.removeAttribute("data-uncloak-src"),e.removeAttribute("data-uncloak-srcset"),0===(t-=1)&&(this.lazyContentLoadStatus=2,this.uncloakReady&&this.uncloak())};for(let e=0;e<this.lazyContent.length;e++){const t=this.lazyContent[e],i=t.getAttribute("data-uncloak-srcset")||null;i&&(t.srcset=i),t.src=t.getAttribute("data-uncloak-src"),t.addEventListener("load",loaded(t),!1)}}imagesLoaded(){return 2===this.lazyContentLoadStatus}}class VideoPlayer{constructor(t,e){this.container=t.container,this.video=t.video||t.container.querySelector("video"),this.promise=null,this.loadStatus=0,this.error=!1,this.requiresResize=this.container.hasAttribute("data-video-resize"),this.autoplay=t.autoplay||0,this.callbacks={durationchange:[],firstPlay:[],playing:[],error:[]},e&&this.init()}init(){if(this.loadStatus>0)return;this.loadStatus=1,this.video.src||(this.video.src=this.video.getAttribute("data-src"),this.video.removeAttribute("data-src")),this.video.addEventListener("loadedmetadata",()=>{this.video.currentTime=.1,this.requiresResize&&this.resizeVideo()},!1),this.video.addEventListener("durationchange",()=>{this.loadStatus=2,this.video.setAttribute("muted",""),this.runCallbacks("durationchange"),this.autoplay&&this.play()},!1);const firstPlayHook=()=>{this.container.classList.add("video-loaded"),this.runCallbacks("firstPlay"),this.video.removeEventListener("playing",firstPlayHook,!1)};this.video.addEventListener("playing",firstPlayHook,!1),this.video.addEventListener("playing",()=>{this.runCallbacks("playing")},!1),this.video.addEventListener("error",()=>{this.disable()},!1)}play(){if(this.isLoading()||!this.video.paused||null!==this.promise)return;0===this.loadStatus&&this.init();const t=this.video.play();void 0!==t&&(this.promise=t,t.then(()=>{this.promise=null}).catch(()=>{this.promise.status&&"rejected"===this.promise.status&&this.disable()})),setTimeout(()=>{this.video.paused&&this.disable()},100)}disable(){this.container.classList.add("video-disabled"),this.error=!0,this.runCallbacks("error")}pause(){this.pauseReady()&&this.video.pause()}reset(){this.pauseReady()&&(this.video.pause(),this.video.currentTime=.1)}pauseReady(){return!this.video.paused&&null===this.promise&&2===this.loadStatus}addCallback(t,e){this.callbacks[t].push(e)}runCallbacks(t){const e=this.callbacks[t];if(e.length)for(let i=0;i<e.length;i++)e[i]()}isDisabled(){return this.error}isPaused(){return this.video.paused}isLoaded(){return 2===this.loadStatus}isLoading(){return 1===this.loadStatus}resizeVideo(){if(this.video.videoHeight/this.video.videoWidth<=this.container.offsetHeight/this.container.offsetWidth)return this.video.style.height="100%",void(this.video.style.width="auto");this.video.style.height="auto",this.video.style.width="100%"}}class UncloakVideoItem extends UncloakItem{constructor(t,e,i){if(super(t,e,i),this.videoPlayer=null,void 0!==VideoPlayer){const e=t.querySelector("."+t.getAttribute("data-uncloak-video"));this.videoPlayer=new VideoPlayer({container:e,autoplay:0},!1),this.videoPlayer.addCallback("firstPlay",()=>{this.uncloak()}),this.videoPlayer.addCallback("error",()=>{this.loadLazyContent(),this.uncloak()})}}init(){this.lazyContentObserver=new IntersectionObserver(t=>{const e=t[0];this.videoPlayer.isDisabled()?(this.loadLazyContent(),this.lazyContentObserver.disconnect()):this.toggleVideoPlay(e.isIntersecting)},{rootMargin:"10%"}),this.lazyContentObserver.observe(this.videoPlayer.container),this.runCallbacks("init")}toggleVideoPlay(t){t?this.videoPlayer.play():this.videoPlayer.pause()}}export default class Uncloak{constructor(t){if(this.items=[],this.hasResizeListener=!1,this.nodeObserver=null,this.itemOptions={delayTypes:{},callbacks:{}},t&&t.itemOptions)for(const e in this.itemOptions)t.itemOptions[e]&&(this.itemOptions[e]=t.itemOptions[e]||{});this.init()}init(){"IntersectionObserver"in window||console.error("uncloak: IntersectionObserver not supported in this browser."),this.nodeObserver=new IntersectionObserver(t=>{let e=0;for(let i=0;i<t.length;i++){const s=t[i].boundingClientRect,a=t[i].isIntersecting||s.top<=0&&s.left<=0&&s.width>=document.body.clientWidth&&s.height>=window.innerHeight;if(a){const o=this.getItemByNode(t[i].target),n=s.height,r=o.threshold*t[i].rootBounds.height;(n>=r?t[i].intersectionRect.height>=r:a)&&(e=o.process(e),this.nodeObserver.unobserve(t[i].target))}}},{rootMargin:"10% 0%",threshold:[.1,.2,.3,.5,.6,.7,.8,.9]}),this.findNewItems()}findNewItems(t=document.querySelectorAll("[data-uncloak-new]")){if(!t[0])return;const e=this.items.length;let i=!1;for(let s=0;s<t.length;s++){const a=t[s],o=e+s;let n;a.hasAttribute("data-uncloak-video")?(n=new UncloakVideoItem(a,this,this.itemOptions),i=!0):n=new UncloakItem(a,this,this.itemOptions),a.id="uncloak-"+o,n.init(),this.nodeObserver.observe(a),this.items.push(n)}if(i&&!this.hasResizeListener){this.hasResizeListener=!0;const update_videos=()=>{for(let t=0;t<this.items.length;t++)"videoPlayer"in this.items[t]&&(this.items[t].videoPlayer.isResponsive&&this.items[t].videoPlayer.setSrc(),this.items[t].videoPlayer.requiresResize&&this.items[t].videoPlayer.resizeVideo())};window.addEventListener("orientationchange",update_videos),window.addEventListener("resize",update_videos)}}getItemByNode(t){const e=t.id.split("-")[1];return this.items[e]}}
