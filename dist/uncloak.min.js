!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Uncloak=e()}(this,function(){"use strict";function d(t,e,i){for(var s in t.removeAttribute("data-uncloak-new"),this.callbacks={init:[],uncloak:[]},this.callbacks)s in i.callbacks&&(this.callbacks[s]=i.callbacks[s]);this.cloaked=!0,this.uncloakReady=!1,this.delayTimer={y0:0,y1:null},this.delayType=t.getAttribute("data-uncloak-delay-type")||null,this.delayTypes=i.delayTypes||{},this.instance=e,this.lazyContent=t.hasAttribute("data-uncloak-ignore-lazy")?[]:t.querySelectorAll("[data-uncloak-src], [data-uncloak-srcset], [data-uncloak-picture]"),this.lazyContentLoadStatus=this.lazyContent[0]?-1:2,this.node=t,this.threshold=parseFloat(t.getAttribute("data-uncloak-threshold"))||0,this.lazyContentObserver=null}d.prototype.init=function(){var e=this;this.lazyContent[0]&&(this.lazyContentObserver=new IntersectionObserver(function(t){t[0].isIntersecting&&(e.loadLazyContent(),e.lazyContentObserver.disconnect())},{rootMargin:"50%"}),this.lazyContentObserver.observe(this.node)),this.runCallbacks("init")},d.prototype.process=function(t){return this.cloaked&&(null!==this.delayType&&null===this.delayTimer.y1&&(this.delayTimer={y0:performance.now(),y1:this.createDelayTimeout(t,this.delayType)},t++),this.mediaLoaded()?this.uncloak():this.uncloakReady=!0),t},d.prototype.uncloak=function(){var t=this;if(this.cloaked){this.cloaked=!1;var e=performance.now()-this.delayTimer.y0,i=this.delayTimer.y1-e,s=function(){t.node.classList.remove("uncloak--cloaked"),t.runCallbacks("uncloak")};i<=0?s():setTimeout(s,i)}},d.prototype.reset=function(t){void 0===t&&(t=!0),this.cloaked=!0,this.delayTimer={y0:0,y1:null},this.node.classList.add("uncloak--cloaked"),t&&this.instance.nodeObserver.observe(this.node)},d.prototype.runCallbacks=function(t){var e=this.callbacks[t];if(e&&e.length)for(var i=0;i<e.length;i++)e[i](this)},d.prototype.createDelayTimeout=function(t,e){return this.delayTypes&&this.delayTypes[e](t)||0},d.prototype.loadLazyContent=function(){var i=this;if(!this.mediaLoaded()&&1!==this.lazyContentLoadStatus){this.lazyContentLoadStatus=1;for(var s=this.lazyContent.length,o=function(t,e){return function(){e.removeEventListener("load",o,!1),t.removeAttribute("data-uncloak-src"),t.removeAttribute("data-uncloak-srcset"),t.removeAttribute("data-uncloak-ie-src"),t.removeAttribute("data-uncloak-alt"),t.removeAttribute("data-uncloak-class"),t.removeAttribute("data-uncloak-picture"),0===--s&&(i.lazyContentLoadStatus=2,i.uncloakReady&&i.uncloak())}},t=0;t<this.lazyContent.length;t++){var e=this.lazyContent[t],a=e.getAttribute("data-uncloak-srcset")||null,n=e;if(a&&(e.srcset=a),e.hasAttribute("data-uncloak-src")&&(e.src=e.getAttribute("data-uncloak-src")),e.hasAttribute("data-uncloak-picture")){var r=document.createElement("img");n=r,this.instance.isIE&&e.hasAttribute("data-uncloak-ie-src")&&(r.src=e.getAttribute("data-uncloak-ie-src")),e.hasAttribute("data-uncloak-alt")&&(r.alt=e.getAttribute("data-uncloak-alt")),e.hasAttribute("data-uncloak-class")&&(r.classList=e.getAttribute("data-uncloak-class")),e.append(r)}n.addEventListener("load",o(e,n),!1)}}},d.prototype.mediaLoaded=function(){return 2===this.lazyContentLoadStatus};function n(t,e){this.container=t.container,this.video=t.video||t.container.querySelector("video"),this.autoplay=t.autoplay||0,this.error=!1,this.isResponsive=!1,this.loadStatus=0,this.promise=null,this.requiresResize=this.container.hasAttribute("data-video-resize"),this.sources=[],this.callbacks={durationchange:[],firstPlay:[],playing:[],error:[]},e&&this.init()}n.prototype.init=function(){var t=this;if(!(0<this.loadStatus)){this.loadStatus=1,this.extractSources(),this.video.src||this.setSrc(),this.video.addEventListener("loadedmetadata",function(){t.video.currentTime=.1,t.requiresResize&&t.resizeVideo()},!1),this.video.addEventListener("durationchange",function(){t.loadStatus=2,t.video.setAttribute("muted",""),t.runCallbacks("durationchange"),t.autoplay&&t.play()},!1);var e=function(){t.container.classList.add("video-loaded"),t.runCallbacks("firstPlay"),t.video.removeEventListener("playing",e,!1)};this.video.addEventListener("playing",e,!1),this.video.addEventListener("playing",function(){t.runCallbacks("playing")},!1),this.video.addEventListener("error",function(){t.disable()},!1)}},n.prototype.disable=function(){this.container.classList.add("video-disabled"),this.error=!0,this.runCallbacks("error")},n.prototype.extractSources=function(){var t=this.video.getAttribute("data-video-srcset")||null;if(null!==t){var e=/^\s*(.+)\s+(\d+)([wh])?\s*$/;t=t.split(",");for(var i=0;i<t.length;i++){var s=t[i].match(e);s&&this.sources.push({src:s[1],width:parseInt(s[2])})}this.sources.sort(function(t,e){return t.width-e.width})}else(t=this.video.getAttribute("data-video-src"))&&(this.sources.push({src:t}),this.video.removeAttribute("data-video-src"));this.isResponsive=1<this.sources.length},n.prototype.play=function(){var t=this;if(!this.isLoading()&&this.video.paused&&null===this.promise){0===this.loadStatus&&this.init();var e=this.video.play();void 0!==e&&(this.promise=e).then(function(){t.promise=null}).catch(function(){t.promise.status&&"rejected"===t.promise.status&&t.disable()}),setTimeout(function(){t.video.paused&&t.disable()},100)}},n.prototype.pause=function(){this.pauseReady()&&this.video.pause()},n.prototype.pauseReady=function(){return!this.video.paused&&null===this.promise&&2===this.loadStatus},n.prototype.reset=function(){this.pauseReady()&&(this.video.pause(),this.video.currentTime=.1)},n.prototype.setSrc=function(){if(this.isResponsive)for(var t=this.container.clientWidth,e=this.video.src.replace(/(https?:)/,""),i=this.video.paused,s=0;s<this.sources.length;s++)if(t<=this.sources[s].width||s===this.sources.length-1)return void(e!==this.sources[s].src&&(this.video.src=this.sources[s].src,i||this.play()));this.video.src=this.sources[0].src},n.prototype.addCallback=function(t,e){this.callbacks[t].push(e)},n.prototype.runCallbacks=function(t){var e=this.callbacks[t];if(e.length)for(var i=0;i<e.length;i++)e[i]()},n.prototype.isDisabled=function(){return this.error},n.prototype.isPaused=function(){return this.video.paused},n.prototype.isLoaded=function(){return 2===this.loadStatus},n.prototype.isLoading=function(){return 1===this.loadStatus},n.prototype.resizeVideo=function(){if(this.video.videoHeight/this.video.videoWidth<=this.container.offsetHeight/this.container.offsetWidth)return this.video.style.height="100%",void(this.video.style.width="auto");this.video.style.height="auto",this.video.style.width="100%"};function t(t){if(this.items=[],this.hasResizeListener=!1,this.nodeObserver=null,this.isIE="undefined"!=typeof document&&document.documentMode,this.itemOptions={delayTypes:{},callbacks:{}},t&&t.itemOptions)for(var e in this.itemOptions)t.itemOptions[e]&&(this.itemOptions[e]=t.itemOptions[e]||{});this.init()}var c=function(a){function t(t,e,i){var s=this;if(a.call(this,t,e,i),this.videoPlayer=null,this.videoAutoplay=!t.hasAttribute("data-uncloak-video-manual"),void 0!==n){var o=t.querySelector("."+t.getAttribute("data-uncloak-video"));if(this.videoPlayer=new n({container:o,autoplay:0},!1),this.videoPlayer.addCallback("error",function(){s.loadLazyContent(),s.uncloak()}),this.videoAutoplay){this.videoPlayer.addCallback("firstPlay",function(){s.uncloak()});this.callbacks.uncloak.push(function(){s.toggleVideoPlay(!0)})}}}return a&&(t.__proto__=a),((t.prototype=Object.create(a&&a.prototype)).constructor=t).prototype.init=function(){var i=this;this.lazyContentObserver=new IntersectionObserver(function(t){var e=t[0];i.videoPlayer.isDisabled()?(i.loadLazyContent(),i.lazyContentObserver.disconnect()):i.toggleVideoPlay(e.isIntersecting)},{rootMargin:"10%"}),this.lazyContentObserver.observe(this.videoPlayer.container),this.runCallbacks("init")},t.prototype.mediaLoaded=function(){return!this.videoPlayer.isDisabled()||2===this.lazyContentLoadStatus},t.prototype.toggleVideoPlay=function(t){t?this.videoPlayer.play():this.videoPlayer.pause()},t}(d);return t.prototype.init=function(){var l=this;"IntersectionObserver"in window||console.error("uncloak: IntersectionObserver not supported in this browser."),this.nodeObserver=new IntersectionObserver(function(t){for(var e=0,i=0;i<t.length;i++){var s=t[i].boundingClientRect,o=t[i].isIntersecting||0<t[i].intersectionRatio||s.top<=window.innerHeight&&s.left<=0&&s.width>=document.body.clientWidth&&s.height>=window.innerHeight;if(o){var a=l.getItemByNode(t[i].target),n=s.height,r=a.threshold*t[i].rootBounds.height;(r<=n?t[i].intersectionRect.height>=r:o)&&(e=a.process(e),l.nodeObserver.unobserve(t[i].target))}}},{rootMargin:"10% 0%",threshold:[.1,.2,.3,.5,.6,.7,.8,.9]}),this.findNewItems()},t.prototype.findNewItems=function(t){var e=this;if(void 0===t&&(t=document.querySelectorAll("[data-uncloak-new]")),t[0]){for(var i=this.items.length,s=!1,o=0;o<t.length;o++){var a=t[o],n=i+o,r=void 0;a.hasAttribute("data-uncloak-video")?(r=new c(a,this,this.itemOptions),s=!0):r=new d(a,this,this.itemOptions),a.id="uncloak-"+n,r.init(),this.nodeObserver.observe(a),this.items.push(r)}if(s&&!this.hasResizeListener){this.hasResizeListener=!0;var l=function(){for(var t=0;t<e.items.length;t++)"videoPlayer"in e.items[t]&&(e.items[t].videoPlayer.isResponsive&&e.items[t].videoPlayer.setSrc(),e.items[t].videoPlayer.requiresResize&&e.items[t].videoPlayer.resizeVideo())};window.addEventListener("orientationchange",l),window.addEventListener("resize",l)}}},t.prototype.getItemByNode=function(t){var e=t.id.split("-")[1];return this.items[e]},t});
